# DynamicNacosGateway
Dynamic Gateway Route base on nacos 基于nacos动态刷新gateway网关路由

## ddd-boot-nacos-local ：本地开发用nacos
```
1、执行sql: db/tables_nacos.sql
2、启动nacos: com.ddfeiyu.dddbootnacoslocal.DddBootNacosLocalApplication

```

### ddd-boot-demo ： 管理gateway

### ddd-boot-gateway ： gateway

#### 1、基于nacos动态刷新gateway，不需要重启服务 ，核心类： DynamicRouteLoader.java
```  关键设计：  
            com.alibaba.nacos.api.config.ConfigService
            org.springframework.cloud.gateway.route.RouteDefinitionRepository
```  
#### 2、监听设计
    可支持
##### 1、数据库加载路由配置如mysql、redis
-   a、基于redis的监听已实现（通过redis的发布订阅）【不推荐生产使用】
    
            以下为示范，其中runoobChat是订阅的频道名称，注意：Redis 客户端可以订阅任意数量的频道。
            客户端1：SUBSCRIBE runoobChat
            客户端2：PUBLISH runoobChat "Redis PUBLISH test"
-   b、redis的发布订阅缺陷
        
        虽然redis实现了发布订阅（publish/subscribe）的功能，但是在通常的情况下是不推荐使用的。
        如果想使用消息队列这种方式，最好还是使用专业的各种MQ中间件，比如rabbitMQ，rockedMQ,activitedMQ等.
    不推荐使用redis的发布订阅功能的原因如下：
     
        主要是因为publish和subscribe的缺陷在于客户端必须一直在线才能接收到消息，断线之后可能导致客户端丢失消息。
    除此之外，旧版本的redis可能由于订阅者消费速度不够快而变得不稳定导致崩溃，甚至被管理员杀掉。
    ```
    1、主要原因是和redis的稳定性有关。
        
        对于旧版本的redis，如果一个客户端订阅了某个或者某几个频道，但是他读取消息的速度不够快，
        那么不断的挤压的消息就会使得redis输出缓冲区的体积越来越大， 这可能会导致redis的速度变慢，甚至直接崩溃。
        也可能会导致redis被操作系统强制杀死，甚至导致操作系统本身不可能。
        
        新版本的Redis不会出现这个问题，是因为他会自动断开不符合 client-output-buffer-limit pubsub配置选项要求的订阅客户端。
            "client-output-buffer-limit"
            "normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60"
        更多redis配置参见[reids配置]
    
    2、和数据传输的可靠性有关
        任何网络系统在执行操作时都可能会遇到断网的情况。
        而断线产生的连接错误通常会使得网络连接两端中的一端进行重新连接。
        如果客户端在执行订阅操作的过程中断线。那么客户端就会丢失在断线期间的消息，这在很多业务场景中是不可接受的。
    ```        
            
            -------------

        b、基于mysql的监听思路：
            监听binlog
##### 2、yml（本地yml加载路由配置）
        暂未实现
##### 3、nacos（nacos加载路由配置）【推荐生产使用】
        基于nacos的监听【已实现】
        关键类：
            com.alibaba.nacos.api.config.ConfigService
            org.springframework.cloud.gateway.route.RouteDefinitionRepository
            org.springframework.cloud.gateway.event.RefreshRoutesEvent
##### 4、基于websocket的监听： SocketHandler
    已实现
##### 5、基于zk的监听： ZookeeperHandler 
    未实现

#### redis配置
``` 
 127.0.0.1:6379> CONFIG GET *
1) "repl-disable-tcp-nodelay"
2) "no"
3) "tls-client-key-file"
4) ""
5) "lazyfree-lazy-expire"
6) "no"
7) "hash-max-listpack-value"
8) "64"
9) "repl-diskless-sync-delay"
10) "5"
11) "replica-serve-stale-data"
12) "yes"
13) "tls-ciphersuites"
14) ""
15) "appendfsync"
16) "everysec"
17) "syslog-ident"
18) "redis"
19) "busy-reply-threshold"
20) "5000"
21) "aof-disable-auto-gc"
22) "no"
23) "active-defrag-threshold-upper"
24) "100"
25) "no-appendfsync-on-rewrite"
26) "no"
27) "protected-mode"
28) "no"
29) "sanitize-dump-payload"
30) "no"
31) "replica-read-only"
32) "yes"
33) "hz"
34) "10"
35) "active-defrag-ignore-bytes"
36) "104857600"
37) "min-slaves-max-lag"
38) "10"
39) "acl-pubsub-default"
40) "resetchannels"
41) "aof-use-rdb-preamble"
42) "yes"
43) "aof-load-truncated"
44) "yes"
45) "save"
46) "3600 1 300 100 60 10000"
47) "tls-session-caching"
48) "yes"
49) "repl-timeout"
50) "60"
51) "client-output-buffer-limit"
52) "normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60"
53) "tls-session-cache-size"
54) "20480"
55) "cluster-config-file"
56) "nodes.conf"
57) "shutdown-on-sigterm"
58) "default"
59) "zset-max-listpack-value"
60) "64"
61) "repl-backlog-size"
62) "1048576"
63) "cluster-allow-pubsubshard-when-down"
64) "yes"
65) "cluster-require-full-coverage"
66) "yes"
67) "disable-thp"
68) "yes"
69) "cluster-link-sendbuf-limit"
70) "0"
71) "syslog-enabled"
72) "no"
73) "cluster-announce-ip"
74) ""
75) "list-max-ziplist-size"
76) "-2"
77) "cluster-announce-bus-port"
78) "0"
79) "repl-diskless-sync-max-replicas"
80) "0"
81) "lazyfree-lazy-user-flush"
82) "no"
83) "server_cpulist"
84) ""
85) "client-query-buffer-limit"
86) "1073741824"
87) "slave-read-only"
88) "yes"
89) "cluster-slave-validity-factor"
90) "10"
91) "tls-ca-cert-file"
92) ""
93) "oom-score-adj-values"
94) "0 200 800"
95) "aof-timestamp-enabled"
96) "no"
97) "cluster-slave-no-failover"
98) "no"
99) "slowlog-log-slower-than"
100) "10000"
101) "activerehashing"
102) "yes"
103) "tls-dh-params-file"
104) ""
105) "unixsocketperm"
106) "0"
107) "bind"
108) "* -::*"
109) "shutdown-on-sigint"
110) "default"
111) "repl-diskless-load"
112) "disabled"
113) "tls-cert-file"
114) ""
115) "port"
116) "6379"
117) "ignore-warnings"
118) ""
119) "aof-rewrite-incremental-fsync"
120) "yes"
121) "zset-max-listpack-entries"
122) "128"
123) "io-threads-do-reads"
124) "no"
125) "lazyfree-lazy-server-del"
126) "no"
127) "slave-lazy-flush"
128) "no"
129) "lua-time-limit"
130) "5000"
131) "tls-ca-cert-dir"
132) ""
133) "tcp-backlog"
134) "511"
135) "cluster-migration-barrier"
136) "1"
137) "rdb-del-sync-files"
138) "no"
139) "notify-keyspace-events"
140) ""
141) "acllog-max-len"
142) "128"
143) "lfu-log-factor"
144) "10"
145) "slave-serve-stale-data"
146) "yes"
147) "always-show-logo"
148) "no"
149) "stop-writes-on-bgsave-error"
150) "yes"
151) "proto-max-bulk-len"
152) "536870912"
153) "replica-priority"
154) "100"
155) "set-max-intset-entries"
156) "512"
157) "cluster-replica-no-failover"
158) "no"
159) "propagation-error-behavior"
160) "ignore"
161) "tls-session-cache-timeout"
162) "300"
163) "cluster-allow-replica-migration"
164) "yes"
165) "tls-key-file-pass"
166) ""
167) "active-defrag-cycle-max"
168) "25"
169) "aclfile"
170) ""
171) "min-replicas-max-lag"
172) "10"
173) "active-expire-effort"
174) "1"
175) "repl-diskless-sync"
176) "yes"
177) "cluster-allow-reads-when-down"
178) "no"
179) "proc-title-template"
180) "{title} {listen-addr} {server-mode}"
181) "stream-node-max-bytes"
182) "4096"
183) "cluster-announce-hostname"
184) ""
185) "latency-tracking-info-percentiles"
186) "50 99 99.9"
187) "list-max-listpack-size"
188) "-2"
189) "min-slaves-to-write"
190) "0"
191) "cluster-announce-port"
192) "0"
193) "appendfilename"
194) "appendonly.aof"
195) "cluster-port"
196) "0"
197) "hash-max-ziplist-value"
198) "64"
199) "crash-memcheck-enabled"
200) "yes"
201) "zset-max-ziplist-value"
202) "64"
203) "slave-announce-ip"
204) ""
205) "lazyfree-lazy-eviction"
206) "no"
207) "active-defrag-max-scan-fields"
208) "1000"
209) "slave-announce-port"
210) "0"
211) "timeout"
212) "0"
213) "slave-priority"
214) "100"
215) "active-defrag-cycle-min"
216) "1"
217) "appenddirname"
218) "appendonlydir"
219) "enable-protected-configs"
220) "no"
221) "replica-announced"
222) "yes"
223) "masterauth"
224) ""
225) "rdb-save-incremental-fsync"
226) "yes"
227) "rdbcompression"
228) "yes"
229) "maxmemory-eviction-tenacity"
230) "10"
231) "rdbchecksum"
232) "yes"
233) "tls-port"
234) "0"
235) "tcp-keepalive"
236) "300"
237) "masteruser"
238) ""
239) "auto-aof-rewrite-min-size"
240) "67108864"
241) "cluster-node-timeout"
242) "15000"
243) "replica-announce-port"
244) "0"
245) "maxclients"
246) "10000"
247) "requirepass"
248) ""
249) "bio_cpulist"
250) ""
251) "repl-backlog-ttl"
252) "3600"
253) "jemalloc-bg-thread"
254) "yes"
255) "pidfile"
256) ""
257) "syslog-facility"
258) "local0"
259) "repl-ping-slave-period"
260) "10"
261) "lfu-decay-time"
262) "1"
263) "supervised"
264) "no"
265) "enable-module-command"
266) "no"
267) "bind-source-addr"
268) ""
269) "repl-ping-replica-period"
270) "10"
271) "loglevel"
272) "notice"
273) "io-threads"
274) "1"
275) "slowlog-max-len"
276) "128"
277) "tls-ciphers"
278) ""
279) "socket-mark-id"
280) "0"
281) "databases"
282) "16"
283) "latency-tracking"
284) "yes"
285) "tracking-table-max-keys"
286) "1000000"
287) "maxmemory-clients"
288) "0"
289) "hash-max-ziplist-entries"
290) "512"
291) "slave-ignore-maxmemory"
292) "yes"
293) "active-defrag-threshold-lower"
294) "10"
295) "tls-auth-clients"
296) "yes"
297) "unixsocket"
298) ""
299) "logfile"
300) ""
301) "aof_rewrite_cpulist"
302) ""
303) "dbfilename"
304) "dump.rdb"
305) "shutdown-timeout"
306) "10"
307) "tls-key-file"
308) ""
309) "daemonize"
310) "no"
311) "cluster-enabled"
312) "no"
313) "maxmemory-samples"
314) "5"
315) "tls-client-key-file-pass"
316) ""
317) "stream-node-max-entries"
318) "100"
319) "replica-ignore-maxmemory"
320) "yes"
321) "replica-announce-ip"
322) ""
323) "oom-score-adj"
324) "no"
325) "enable-debug-command"
326) "no"
327) "latency-monitor-threshold"
328) "0"
329) "hash-max-listpack-entries"
330) "512"
331) "activedefrag"
332) "no"
333) "list-compress-depth"
334) "0"
335) "dir"
336) "/data"
337) "tls-prefer-server-ciphers"
338) "no"
339) "maxmemory-policy"
340) "noeviction"
341) "replicaof"
342) ""
343) "replica-lazy-flush"
344) "no"
345) "cluster-preferred-endpoint-type"
346) "ip"
347) "lazyfree-lazy-user-del"
348) "no"
349) "maxmemory"
350) "0"
351) "tls-cluster"
352) "no"
353) "slaveof"
354) ""
355) "cluster-announce-tls-port"
356) "0"
357) "crash-log-enabled"
358) "yes"
359) "tls-replication"
360) "no"
361) "auto-aof-rewrite-percentage"
362) "100"
363) "hll-sparse-max-bytes"
364) "3000"
365) "dynamic-hz"
366) "yes"
367) "replica-ignore-disk-write-errors"
368) "no"
369) "zset-max-ziplist-entries"
370) "128"
371) "tls-client-cert-file"
372) ""
373) "appendonly"
374) "no"
375) "set-proc-title"
376) "yes"
377) "bgsave_cpulist"
378) ""
379) "cluster-replica-validity-factor"
380) "10"
381) "min-replicas-to-write"
382) "0"
383) "tls-protocols"
384) ""
```